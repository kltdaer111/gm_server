<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <meta name="renderer" content="webkit|ie-comp|ie-stand">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <!--[if lt IE 9]>
<script type="text/javascript" src="lib/html5shiv.js"></script>
<script type="text/javascript" src="lib/respond.min.js"></script>
<![endif]-->
  <link rel="stylesheet" type="text/css" href="../dep/static/h-ui/css/H-ui.min.css" />
  <link rel="stylesheet" type="text/css" href="../dep/static/h-ui.admin/css/H-ui.admin.css" />
  <link rel="stylesheet" type="text/css" href="../dep/lib/Hui-iconfont/1.0.8/iconfont.css" />
  <link rel="stylesheet" type="text/css" href="../dep/static/h-ui.admin/skin/default/skin.css" id="skin" />
  <link rel="stylesheet" type="text/css" href="../dep/static/h-ui.admin/css/style.css" />
  <link rel="stylesheet" type="text/css" href="../dep/lib/layui/css/layui.css" />
  <script type="text/javascript" src="../dep/lib/jquery/1.9.1/jquery.min.js"></script>
  <script type="text/javascript" src="../dep/static/h-ui/js/H-ui.min.js"></script>
  <script type="text/javascript" src="../dep/static/h-ui.admin/js/H-ui.admin.js"></script>
  <script type="text/javascript" src="../dep/lib/My97DatePicker/4.8/WdatePicker.js"></script>
  <script type="text/javascript" src="../dep/lib/datatables/1.10.0/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="../dep/lib/layui/layui.js" charset="utf-8"></script>
  <script type="text/javascript" src="../dep/js/server_list_common.js" charset="utf-8"></script>
  <script type="text/javascript" src="../dep/js/common.js" charset="utf-8"></script>
  <script type="text/javascript" src="../dep/lib/hcharts/Highcharts/5.0.6/js/highcharts.js"></script>
  <script type="text/javascript" src="../dep/lib/hcharts/Highcharts/5.0.6/js/modules/exporting.js"></script>
  <script type="text/javascript" src="../dep/js/config.js" charset="utf-8"></script>
  <script type="text/javascript" src="./server_status.js" charset="utf-8"></script>
  <!--[if IE 6]>
<script type="text/javascript" src="lib/DD_belatedPNG_0.0.8a-min.js" ></script>
<script>DD_belatedPNG.fix('*');</script>
<![endif]-->
  <title>后台监控</title>
  <style type="text/css">
    html,
    body {
      height: auto;
    }

    #suggest,
    #suggest2 {
      width: 200px;
    }

    .gray {
      color: gray;
    }

    .ac_results {
      background: #fff;
      border: 1px solid #7f9db9;
      position: absolute;
      z-index: 10000;
      display: none;
    }

    .ac_results li a {
      white-space: nowrap;
      text-decoration: none;
      display: block;
      color: #05a;
      padding: 1px 3px;
    }

    .ac_results li {
      border: 1px solid #fff;
    }

    .ac_over,
    .ac_results li a:hover {
      background: #c8e3fc;
    }

    .ac_results li a span {
      float: right;
    }

    .ac_result_tip {
      border-bottom: 1px dashed #666;
      padding: 3px;
    }

    body {
      overflow-y: scroll;
    }
  </style>

</head>

<body>
  <div class="layui-tab layui-tab-card">
    <ul class="layui-tab-title">
      <li class="layui-this">服务器操作</li>
      <li>操作记录</li>
      <li>服务器拷贝</li>
      <li>拷贝记录</li>
    </ul>
    <div class="layui-tab-content">
      <div class="layui-tab-item layui-show">
        <!-- 分页数据 -->
        <div class="layui-fluid">
          <form class="layui-form" action="">

            <div class="layui-row">
              <div class="layui-col-lg1">
                <label class="layui-form-label">游戏</label>
              </div>
              <div class="layui-col-lg4">
                <select name="choose_game">
                  <option value="">请选择游戏</option>
                  <option value="0">少年逆命师</option>
                </select>
              </div>

              <div class="layui-col-lg1">
                <label class="layui-form-label">服务器组</label>
              </div>

              <div class="layui-col-lg4">
                <select name="choose_server" id='group'>
                  <option value="">请选择服务器</option>
                </select>
              </div>

              <div class="layui-col-lg1 layui-col-md-offset1">
                <button class="layui-btn" lay-submit lay-filter='filter'>筛选</button>
              </div>
            </div>
            <div class="layui-row">
              <div class="layui-input-block"></div>
            </div>
            <div class="layui-row">

              <div class="layui-col-lg3 layui-col-md-offset1">
                <input type="radio" name="operation" value='1' title='开启服务器'>
              </div>
              <div class="layui-col-lg3">
                <input type="radio" name="operation" value='2' title="关闭服务器">
              </div>
              <div class="layui-col-lg3">
                <input type="radio" name="operation" value='3' title="重启服务器">
              </div>

              <div class="layui-col-lg1 layui-col-md-offset1">
                <button class="layui-btn" lay-submit lay-filter='exec'>执行</button>
              </div>
            </div>
          </form>
          <table class="layui-table" id='tab_oper_status'>
            <!-- <colgroup>
              <col width="150">
              <col width="200">
              <col>
            </colgroup> -->
          </table>
        </div>
      </div>
      <div class="layui-tab-item">
        <div class="layui-fluid">
          <form class="layui-form" action="">
            <div class="layui-row">
              <div class="layui-col-lg1">
                <input type="radio" name="query_choice" value="group" title="服务器组">
              </div>
              <div class="layui-col-lg3">
                <select name="oper_choose_server_group" id='operation_group' lay-filter='operation_group'>
                  <option value="">请选择服务器组</option>
                </select>
              </div>
              <div class="layui-col-lg1  layui-col-md-offset1">
                <input type="radio" name="query_choice" value="single" title="服务器名称">
              </div>
              <div class="layui-col-lg3">
                <select name="oper_choose_server" id='operation_server'>
                  <option value="">请选择服务器</option>
                </select>
              </div>
            </div>

            <div class="layui-row">
            </div>


            <div class="layui-row">
              <div class="layui-col-lg1 layui-col-md-offset2">
                <label class="layui-form-label">日期范围</label>
              </div>
              <div class="layui-col-lg3">
                <input type="text" class="layui-input" id="date">
              </div>

              <div class="layui-col-lg1 layui-col-md-offset2">
                <div class="layui-form-item">
                  <button class="layui-btn" lay-submit id='query' lay-filter='query'>查询</button>
                </div>
              </div>
            </div>
          </form>
          <table class="layui-table">
            <colgroup>
              <col width="150">
              <col width="200">
              <col>
            </colgroup>
            <thead>
              <tr>
                <th>服务器组</th>
                <th>服务器名称</th>
                <th>操作类型</th>
                <th>操作用户</th>
                <th>操作时间</th>
              </tr>
            </thead>
            <tbody id='log-table'>
            </tbody>
          </table>

        </div>
      </div>
      <div class="layui-tab-item">
        <!-- 服务器拷贝 -->
        <div class="layui-fluid">
          <form class="layui-form" action="">

            <div class="layui-row">
              <div class="layui-col-lg1">
                <label class="layui-form-label">游戏</label>
              </div>
              <div class="layui-col-lg4">
                <select name="choose_game">
                  <option value="">请选择游戏</option>
                  <option value="0">少年逆命师</option>
                </select>
              </div>

              <div class="layui-col-lg1">
                <label class="layui-form-label">拷贝源</label>
              </div>

              <div class="layui-col-lg4">
                <select name="tab_copy_choose_server" id='tab_copy_group'>
                  <option value="">请选择服务器</option>
                </select>
              </div>

              <!-- <div class="layui-col-lg1 layui-col-md-offset1">
                <button class="layui-btn" lay-submit lay-filter='filter'>筛选</button>
              </div> -->
            </div>

            <!-- <div class="layui-row">
              <div class="layui-input-block"></div>
            </div> -->

            <div class="layui-row">
              <div class="layui-col-lg2 layui-col-md-offset8">
                <select name="tab_copy_choose_version" id='tab_copy_choose_version'>
                  <option value="">请选择版本</option>
                </select>
              </div>
            </div>

            <div class="layui-row">

              <div class="layui-col-lg3 layui-col-md-offset1">
                <input type="radio" name="operation" value='1' title='开启服务器'>
              </div>
              <div class="layui-col-lg3">
                <input type="radio" name="operation" value='2' title="关闭服务器">
              </div>
              <div class="layui-col-lg3">
                <input type="radio" name="operation" value='3' title="重启服务器">
              </div>

              <div class="layui-col-lg1 layui-col-md-offset1">
                <button class="layui-btn" lay-submit lay-filter='exec'>执行</button>
              </div>
            </div>
          </form>
          <table class="layui-table">
            <colgroup>
              <col width="150">
              <col width="200">
              <col>
            </colgroup>
            <thead>
              <tr>
                <th>
                  <button class="layui-btn">全选</button>
                </th>
                <th>服务器组</th>
                <th>服务器名称</th>
                <th>服务器ID</th>
                <th>服务器IP</th>
                <th>当前状态</th>
              </tr>
            </thead>
            <tbody id='main'>

            </tbody>
          </table>
        </div>
      </div>
      <div class="layui-tab-item">
        <div class="layui-fluid">
          <form class="layui-form" action="">
            <div class="layui-row">
              <div class="layui-col-lg1">
                <input type="radio" name="query_choice" value="group" title="服务器组">
              </div>
              <div class="layui-col-lg3">
                <select name="oper_choose_server_group" id='operation_group' lay-filter='operation_group'>
                  <option value="">请选择服务器组</option>
                </select>
              </div>
              <div class="layui-col-lg1  layui-col-md-offset1">
                <input type="radio" name="query_choice" value="single" title="服务器名称">
              </div>
              <div class="layui-col-lg3">
                <select name="oper_choose_server" id='operation_server'>
                  <option value="">请选择服务器</option>
                </select>
              </div>
            </div>

            <div class="layui-row">
            </div>


            <div class="layui-row">
              <div class="layui-col-lg1 layui-col-md-offset2">
                <label class="layui-form-label">日期范围</label>
              </div>
              <div class="layui-col-lg3">
                <input type="text" class="layui-input" id="date">
              </div>

              <div class="layui-col-lg1 layui-col-md-offset2">
                <div class="layui-form-item">
                  <button class="layui-btn" lay-submit id='query' lay-filter='query'>查询</button>
                </div>
              </div>
            </div>
          </form>
          <table class="layui-table">
            <colgroup>
              <col width="150">
              <col width="200">
              <col>
            </colgroup>
            <thead>
              <tr>
                <th>服务器组</th>
                <th>服务器名称</th>
                <th>操作类型</th>
                <th>操作用户</th>
                <th>操作时间</th>
              </tr>
            </thead>
            <tbody id='log-table'>
            </tbody>
          </table>

        </div>
      </div>

    </div>
  </div>

  <!-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++   -->

  <script>
    
    var sss_obj;
    
    //服务器组数据
    var server_group_data = {};
    //当前选择的时间范围
    var period_select = {};

    var CHECK_INTERVAL = 5000;  //ms


    var OPERATION_TYPE = {
      1: '开启服务器',
      2: '关闭服务器',
      3: '重启服务器',
    }

    function reset_select_from_of_operation_server() {
      $('#operation_server').empty();
      $('#operation_server').append('<option value="">请选择服务器</option>');
    }

    //过滤颜色字符
    function filter_color_char(str) {
      return str.replace(/\033\S*?m/g, '');
    }

    layui.use(['form', 'layedit', 'element', 'table', 'laydate', 'layer'], function () {
      var laydate = layui.laydate;
      var form = layui.form;
      var layer = layui.layer;
      //执行一个laydate实例
      laydate.render({
        elem: '#date',
        type: 'datetime',
        range: '~',
        done: function (value, date, endDate) {
          period_select['start'] = date;
          period_select['end'] = endDate;
          // console.log(value); //得到日期生成的值，如：2017-08-18
          // console.log(date); //得到日期时间对象：{year: 2017, month: 8, date: 18, hours: 0, minutes: 0, seconds: 0}
          // console.log(endDate); //得结束的日期时间对象，开启范围选择（range: true）才会返回。对象成员同上。
        },
      });

      //监听【执行】按钮
      form.on('submit(exec)', function (data) {
        sss_obj.do_server_operation(data.field.operation);
        return false;
      });

      //监听【筛选】按钮
      form.on('submit(filter)', function (data) {
        console.log(data);
        console.log(server_group_data);
        if(sss_obj !== undefined){
          sss_obj.stop_interval_check();
        }
        var group_name = data.field.choose_server;
        var start_id = server_group_data[group_name]['group_start_id'];
        var end_id = server_group_data[group_name]['group_end_id'];
        var send_data = {
          'start_id': start_id,
          'end_id': end_id
        };
        send_msg_to_server(1, send_data, function (res) {
          console.log(res);
          sss_obj = new ServerStatusSuit('tab_oper_status', res, group_name, 5000);
          sss_obj.generate_table();
          sss_obj.start_interval_check();
        });
        return false;
      });

      //监听【查询】按钮
      form.on('submit(query)', function (data) {
        var date = $('#date').val();
        console.log(date);
        console.log('query');
        console.log(data);
        var send_data = {
          server_group: data.field.oper_choose_server_group,
          server_group_data: server_group_data,
          server_id: data.field.oper_choose_server,
          query_type: data.field.query_choice,
          start_date: period_select['start'],
          end_date: period_select['end'],
          date: date,
        }
        console.log(send_data);
        send_msg_to_server(5, send_data, function (result) {
          console.log(result);
          var res = result['data'];
          var group_name = result['group'];
          $('#log-table').empty();
          for (idx in res) {
            var tr_xml = '<tr id=' + res[idx]['server_id'] + '>';
            $('#log-table').append(tr_xml);
            $('#log-table').append('<td>' + group_name + '</td>');
            $('#log-table').append('<td>' + res[idx]['server_name'] + '</td>');
            $('#log-table').append('<td>' + OPERATION_TYPE[res[idx]['operation_type']] + '</td>');
            $('#log-table').append('<td>' + res[idx]['operation_user'] + '</td>');
            $('#log-table').append('<td>' + res[idx]['operation_date'] + '</td>');
            $('#log-table').append('</tr>');
          }
          renderForm();
        });
        return false;
      });

      //监听checkbox
      form.on('checkbox()', function (data) {
        console.log(data);
        if (data.elem.checked) {
          sss_obj.server_checked[data.value] = 1;
        }
        else {
          delete sss_obj.server_checked[data.value];
        }
      });

      //监听select事件
      form.on('select(operation_group)', function (data) {
        console.log(data);
        var start_id = server_group_data[data.value]['group_start_id'];
        var end_id = server_group_data[data.value]['group_end_id'];
        var send_data = {
          'start_id': start_id,
          'end_id': end_id
        };
        send_msg_to_server(1, send_data, function (res) {
          console.log(res);
          reset_select_from_of_operation_server();
          for (idx in res) {
            if (res[idx]['ip'] !== null) {
              $('#operation_server').append("<option value='" + res[idx]['server_id'] + "'>" + res[idx]['server_name'] + "</option>");
            }
          }
          renderForm();
        });
      });
    });

    //页面预加载
    $(document).ready(function () {
      var data = [{
        'table_name': 'server_group',
      }];
      get_need_info_and_callback_it('sg_gm', data, function (res) {
        console.log(res);
        for (idx in res) {
          $('#group').append("<option value='" + res[idx]['group_name'] + "'>" + res[idx]['group_name'] + "</option>");
          $('#operation_group').append("<option value='" + res[idx]['group_name'] + "'>" + res[idx]['group_name'] + "</option>");
          server_group_data[res[idx]['group_name']] = res[idx];
        }
        renderForm();
      });


    });
  </script>

</body>

</html>