<!DOCTYPE HTML>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
      content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"
      />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <!--[if lt IE 9]>
<script type="text/javascript" src="lib/html5shiv.js"></script>
<script type="text/javascript" src="lib/respond.min.js"></script>
<![endif]-->
    <link rel="stylesheet" type="text/css"
      href="../dep/static/h-ui/css/H-ui.min.css" />
    <link rel="stylesheet" type="text/css"
      href="../dep/static/h-ui.admin/css/H-ui.admin.css" />
    <link rel="stylesheet" type="text/css"
      href="../dep/lib/Hui-iconfont/1.0.8/iconfont.css" />
    <link rel="stylesheet" type="text/css"
      href="../dep/static/h-ui.admin/skin/default/skin.css" id="skin" />
    <link rel="stylesheet" type="text/css"
      href="../dep/static/h-ui.admin/css/style.css" />
    <link rel="stylesheet" type="text/css" href="../dep/lib/layui/css/layui.css"
      />
    <script type="text/javascript" src="../dep/lib/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="../dep/static/h-ui/js/H-ui.min.js"></script>
    <script type="text/javascript"
      src="../dep/static/h-ui.admin/js/H-ui.admin.js"></script>
    <script type="text/javascript"
      src="../dep/lib/My97DatePicker/4.8/WdatePicker.js"></script>
    <script type="text/javascript"
      src="../dep/lib/datatables/1.10.0/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="../dep/lib/layui/layui.js"
      charset="utf-8"></script>
    <script type="text/javascript" src="../dep/js/server_list_common.js"
      charset="utf-8"></script>
    <script type="text/javascript" src="../dep/js/common.js" charset="utf-8"></script>
    <script type="text/javascript"
      src="../dep/lib/hcharts/Highcharts/5.0.6/js/highcharts.js"></script>
    <script type="text/javascript"
      src="../dep/lib/hcharts/Highcharts/5.0.6/js/modules/exporting.js"></script>
    <script type="text/javascript" src="../dep/js/config.js" charset="utf-8"></script>
    <script type="text/javascript" src="./server_status.js" charset="utf-8"></script>
    <script type="text/javascript" src="./operation_log.js" charset="utf-8"></script>
    <!--[if IE 6]>
<script type="text/javascript" src="lib/DD_belatedPNG_0.0.8a-min.js" ></script>
<script>DD_belatedPNG.fix('*');</script>
<![endif]-->
    <title>后台监控</title>
    <style type="text/css">
    html,
    body {
      height: auto;
    }

    #suggest,
    #suggest2 {
      width: 200px;
    }

    .gray {
      color: gray;
    }

    .ac_results {
      background: #fff;
      border: 1px solid #7f9db9;
      position: absolute;
      z-index: 10000;
      display: none;
    }

    .ac_results li a {
      white-space: nowrap;
      text-decoration: none;
      display: block;
      color: #05a;
      padding: 1px 3px;
    }

    .ac_results li {
      border: 1px solid #fff;
    }

    .ac_over,
    .ac_results li a:hover {
      background: #c8e3fc;
    }

    .ac_results li a span {
      float: right;
    }

    .ac_result_tip {
      border-bottom: 1px dashed #666;
      padding: 3px;
    }

    body {
      overflow-y: scroll;
    }
  </style>
  </head>

  <body>
    <div class="layui-tab layui-tab-card">
      <ul class="layui-tab-title">
        <li class="layui-this">服务器操作</li>
        <li>操作记录</li>
        <li>服务器拷贝</li>
        <li>拷贝记录</li>
        <li>服务器更新</li>
        <li>更新记录</li>
      </ul>
      <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">
          <!-- 服务器操作 -->
          <div class="layui-fluid">
            <form class="layui-form" action="">

              <div class="layui-row">
                <div class="layui-col-lg1">
                  <label class="layui-form-label">游戏</label>
                </div>
                <div class="layui-col-lg4">
                  <select name="choose_game">
                    <option value="">请选择游戏</option>
                    <option value="0">少年逆命师</option>
                  </select>
                </div>

                <div class="layui-col-lg1">
                  <label class="layui-form-label">服务器组</label>
                </div>

                <div class="layui-col-lg4">
                  <select name="choose_server" id='group'>
                    <option value="">请选择服务器</option>
                  </select>
                </div>

                <div class="layui-col-lg1 layui-col-md-offset1">
                  <button class="layui-btn" lay-submit lay-filter='filter'>筛选</button>
                </div>
              </div>
              <div class="layui-row">
                <div class="layui-input-block"></div>
              </div>
              <div class="layui-row">

                <div class="layui-col-lg3 layui-col-md-offset1">
                  <input type="radio" name="operation" value='开启服务器'
                    title='开启服务器'>
                </div>
                <div class="layui-col-lg3">
                  <input type="radio" name="operation" value='关闭服务器'
                    title="关闭服务器">
                </div>
                <div class="layui-col-lg3">
                  <input type="radio" name="operation" value='重启服务器'
                    title="重启服务器">
                </div>

                <div class="layui-col-lg1 layui-col-md-offset1">
                  <button class="layui-btn" lay-submit lay-filter='exec'>执行</button>
                </div>
              </div>
            </form>
            <table class="layui-table" id='tab_oper_status'>
              <!-- <colgroup>
              <col width="150">
              <col width="200">
              <col>
            </colgroup> -->
            </table>
          </div>
        </div>
        <div class="layui-tab-item" id="tab_actionlog">
          <!-- 开关服日志 -->

        </div>
        <div class="layui-tab-item">
          <!-- 服务器拷贝 -->
          <div class="layui-fluid">
            <form class="layui-form" action="">

              <div class="layui-row">
                <div class="layui-col-lg1">
                  <label class="layui-form-label">游戏</label>
                </div>
                <div class="layui-col-lg4">
                  <select name="choose_game">
                    <option value="">请选择游戏</option>
                    <option value="0">少年逆命师</option>
                  </select>
                </div>

                <div class="layui-col-lg1">
                  <label class="layui-form-label">拷贝源</label>
                </div>

                <div class="layui-col-lg4">
                  <select name="tab_copy_choose_source"
                    id='tab_copy_choose_source'
                    lay-filter='tab_copy_choose_source'>
                    <option value="">请选择服务器</option>
                  </select>
                </div>

                <!-- <div class="layui-col-lg1 layui-col-md-offset1">
                <button class="layui-btn" lay-submit lay-filter='filter'>筛选</button>
              </div> -->
              </div>

              <!-- <div class="layui-row">
              <div class="layui-input-block"></div>
            </div> -->
              <div class="layui-row">
                <div class="layui-col-lg2 layui-col-md-offset8">
                  <select name="tab_copy_choose_version"
                    id='tab_copy_choose_version'>
                    <option value="">请选择版本</option>
                  </select>
                </div>
              </div>

              <div class="layui-row">
                <div class="layui-col-lg1">
                  <label class="layui-form-label">服务器组</label>
                </div>

                <div class="layui-col-lg4">
                  <select name="tab_copy_choose_group"
                    id='tab_copy_choose_group'>
                    <option value="">请选择服务器组</option>
                  </select>
                </div>

                <div class="layui-col-lg2 layui-col-md-offset1">
                  <button class="layui-btn" lay-submit
                    lay-filter='tab_copy_filter'>查询服务器</button>
                </div>
              </div>

              <div class="layui-row">
                <div class="layui-input-block"></div>
              </div>

              <div class="layui-row">
                <div class="layui-col-lg3 layui-col-md-offset1">
                  <input type="radio" name="tab_copy_operation" value='关服更新'
                    title='关服更新'>
                </div>
                <div class="layui-col-lg1">
                  <input type="radio" name="tab_copy_operation" value='不关服更新'
                    title="不关服更新">
                </div>
                <div class="layui-col-lg1 layui-col-md-offset1">
                  <button class="layui-btn" lay-submit
                    lay-filter='tab_copy_exec'>执行</button>
                </div>
              </div>
            </form>

            <table class="layui-table" id='tab_copy_status'>
              <!-- <colgroup>
              <col width="150">
              <col width="200">
              <col>
            </colgroup> -->
            </table>
          </div>
        </div>

        <div class="layui-tab-item" id="tab_copylog">
          <!-- 拷贝日志 -->
        </div>

        <div class="layui-tab-item" id="tab_update">
          <!-- 更新 -->
          <form class="layui-form" action="">
            <div class="layui-row">
              <div class="layui-col-lg1">
                <div class="layui-row">
                  <div class="layui-col-lg1 layui-col-md-offset4">
                    <input type="checkbox" name=""
                      disabled id="tab_update_checkbox1"
                      lay-filter="tab_update_checkbox">
                  </div>
                </div>
              </div>
              <div class="layui-col-lg7">
                <input type="text" name="tab_update_text1"
                  placeholder="请输入更新代码文件路径"
                  autocomplete="off" class="layui-input"
                  oninput="EnableCheckBox('tab_update_text1',
                  'tab_update_submit1')" id="tab_update_text1">
              </div>
              <div class="layui-col-lg1">
                <button class="layui-btn layui-btn-radius layui-btn-disabled"
                  lay-submit id="tab_update_submit1"
                  lay-filter='tab_update_submit'>提交</button>
              </div>
            </div>

            <div class="layui-row">
              <div class="layui-col-lg1">
                <div class="layui-row">
                  <div class="layui-col-lg1 layui-col-md-offset4">
                    <input type="checkbox" name=""
                      disabled id="tab_update_checkbox2"
                      lay-filter="tab_update_checkbox">
                  </div>
                </div>
              </div>
              <div class="layui-col-lg7">
                <input type="text" name="tab_update_text2"
                  placeholder="请输入更新tbl文件名"
                  autocomplete="off" class="layui-input"
                  oninput="EnableCheckBox('tab_update_text2',
                  'tab_update_submit2')" id="tab_update_text2">
              </div>
              <div class="layui-col-lg1">
                <button class="layui-btn layui-btn-radius layui-btn-disabled"
                  lay-submit
                  lay-filter='tab_update_submit' id='tab_update_submit2'>提交</button>
              </div>
            </div>

            <div class="layui-row">
              <div class="layui-col-lg1">
                <div class="layui-row">
                  <div class="layui-col-lg1 layui-col-md-offset4">
                    <input type="checkbox" name=""
                      disabled id="tab_update_checkbox3"
                      lay-filter="tab_update_checkbox">
                  </div>
                </div>
              </div>
              <div class="layui-col-lg7">
                <input type="text" name="tab_update_text3"
                  placeholder="请输入更新lua文件路径"
                  autocomplete="off" class="layui-input"
                  oninput="EnableCheckBox('tab_update_text3',
                  'tab_update_submit3')" id="tab_update_text3">
              </div>
              <div class="layui-col-lg1">
                <button class="layui-btn layui-btn-radius layui-btn-disabled"
                  lay-submit
                  lay-filter='tab_update_submit' id='tab_update_submit3'>提交</button>
              </div>
            </div>

            <div class="layui-row">
              <div class="layui-col-lg1">
                <div class="layui-row">
                  <div class="layui-col-lg1 layui-col-md-offset4">
                    <input type="checkbox" name=""
                      disabled id="tab_update_checkbox4"
                      lay-filter="tab_update_checkbox">
                  </div>
                </div>
              </div>
              <div class="layui-col-lg7">
                <input type="text" name="tab_update_text4"
                  placeholder="请输入更新map文件路径"
                  autocomplete="off" class="layui-input"
                  oninput="EnableCheckBox('tab_update_text4',
                  'tab_update_submit4')" id="tab_update_text4">
              </div>
              <div class="layui-col-lg1">
                <button class="layui-btn layui-btn-radius layui-btn-disabled"
                  lay-submit
                  lay-filter='tab_update_submit' id='tab_update_submit4'>提交</button>
              </div>
            </div>

            <div class="layui-row">
              <div class="layui-input-block"></div>
            </div>

            <div class="layui-row">
              <div class="layui-col-lg1 layui-col-md-offset6">
                <button class="layui-btn" lay-submit
                  lay-filter='tab_update_clearall'>清除提交</button>
              </div>
              <div class="layui-col-lg1">
                <button class="layui-btn layui-btn-disabled" lay-submit
                  lay-filter='tab_update_submitall' id='tab_update_submitall'>执行更新</button>
              </div>
            </div>
          </form>
          <div class="layui-row">
            <div class="layui-input-block"></div>
          </div>
          <from class="layui-form" action="">
            <div class="layui-row">
              <div class="layui-col-lg1">
                <label class="layui-form-label">游戏</label>
              </div>
              <div class="layui-col-lg4">
                <select name="tab_update_choosegame">
                  <option value="">请选择游戏</option>
                  <option value="0">少年逆命师</option>
                </select>
              </div>

              <div class="layui-col-lg1">
                <label class="layui-form-label">服务器组</label>
              </div>

              <div class="layui-col-lg4">
                <select name="tab_update_choosegroup"
                  id='tab_update_choosegroup'>
                  <option value="">请选择服务器组</option>
                </select>
              </div>

              <div class="layui-col-lg1 layui-col-md-offset1">
                <button class="layui-btn" lay-submit
                  lay-filter='tab_update_filter'>筛选</button>
              </div>
            </div>
          </from>
          <table class="layui-table" id='tab_update_status'>
          </table>
        </div>

        <div class="layui-tab-item" id="tab_updatelog">
          <!-- 更新日志 -->
        </div>

      </div>
    </div>

    <!-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++   -->
    <script>
    function EnableCheckBox(text_id, button_id){
      console.log($('#' + text_id).val());
      if($('#' + text_id).val() != ''){
        $('#' + button_id).attr('class', "layui-btn layui-btn-radius layui-btn-primary");
      }
      else{
        $('#' + button_id).attr('class', "layui-btn layui-btn-radius layui-btn-disabled");
      }
    }
    
    function UpdateSubmitallButtonState(){
      var disabled = true;
      for(let id = 1; id <= 4; id++){
        var label = '#tab_update_checkbox' + id;
        if($(label).prop('checked') === true){
          disabled = false;
          break;
        }
      }
      if(disabled === true){
        $('#tab_update_submitall').attr('class', 'layui-btn layui-btn-disabled');
      }
      else{
        $('#tab_update_submitall').attr('class', 'layui-btn');
      }
      renderForm();
    }

    var tab_oper_server_status, tab_copy_server_status, tab_update_server_status;

    var tab_actionlog = new OperationLogTab('tab_actionlog', layui);
    tab_actionlog.RegType('开启服务器');
    tab_actionlog.RegType('关闭服务器');
    tab_actionlog.RegType('重启服务器');
    tab_actionlog.addCol('group_name', '服务器组');
    tab_actionlog.addCol('server_name', '服务器');
    tab_actionlog.addCol('operation_type', '操作类型');
    tab_actionlog.addCol('operation_user', '操作用户');
    tab_actionlog.addCol('operation_date', '操作时间');

    var tab_copylog = new OperationLogTab('tab_copylog', layui);
    tab_copylog.addCol('operation_user', '操作用户');
    tab_copylog.addCol('server_name', '服务器');
    tab_copylog.addCol('extra_data', '服务器版本', function(data){
      var array = data.split(';');
      return array[1];
    });
    tab_copylog.addCol('extra_data', '拷贝目标服务器组', function(data){
      var array = data.split(';');
      return array[0];
    });
    tab_copylog.addCol('ip', '拷贝目标服务器IP');
    tab_copylog.addCol('operation_date', '操作时间');
    tab_copylog.RegType('不关服更新');
    tab_copylog.RegType('关服更新');
    
    var tab_updatelog = new OperationLogTab('tab_updatelog', layui);
    tab_updatelog.addCol('operation_user', '用户名');
    tab_updatelog.addCol('server_name', '服务器名称');
    tab_updatelog.addCol('ip', '服务器IP');
    tab_updatelog.addCol('extra_data', '更新文件');
    tab_updatelog.addCol('operation_date', '操作时间');
    tab_updatelog.RegType('执行更新');

    //服务器组数据
    var server_group_data = {};
    //当前选择的时间范围
    var period_select = {};

    var CHECK_INTERVAL = 5000;  //ms


    var OPERATION_TYPE = {
      1: '开启服务器',
      2: '关闭服务器',
      3: '重启服务器',
    }

    //过滤颜色字符
    function filter_color_char(str) {
      return str.replace(/\033\S*?m/g, '');
    }

    layui.use(['form', 'layedit', 'element', 'table', 'laydate', 'layer'], function () {
      var laydate = layui.laydate;
      var form = layui.form;
      var layer = layui.layer;
      //监听tab_update【提交】按钮
      form.on('submit(tab_update_submit)', function (data) {
        var id = data.elem.id.charAt(data.elem.id.length - 1);
        var text_id = 'tab_update_text' + id;
        console.log(text_id);
        console.log(data);
        var input = data.field[text_id];
        if(input == ''){
          return false;
        }
        //TODO参数检查
        

        input = input.replace(';', '<br>');
        layer.confirm(input, {
            title : '请确认输入的信息:'
          },
          function(index){

            //1按钮禁用
            var button_label = '#tab_update_submit' + id;
            $(button_label).attr('class', 'layui-btn layui-btn-radius layui-btn-disabled');
            $(button_label).text('已提交');
            //2text栏不可更改
            $('#' + text_id).attr('disabled', true);
            //3checkbox可选
            var checkbox_label = '#tab_update_checkbox' + id;
            $(checkbox_label).attr('disabled', false);
            renderForm();
            layer.close(index);
        });
        console.log(id);
        return false;
      });

      //监听【执行】按钮
      form.on('submit(exec)', function (data) {
        console.log(data);
        tab_oper_server_status.do_server_operation(data.field.operation);
        return false;
      });
      //监听服务器更新【checkbox】
      form.on('checkbox(tab_update_checkbox)', function(data){
        console.log(data);
        //var id = data.elem.id.charAt(data.elem.id.length - 1);
        UpdateSubmitallButtonState();
      });
      //监听服务器更新【执行更新】按钮
      form.on('submit(tab_update_submitall)', function(data){
        var res = {}
        for(let id = 1; id <= 4; id++){
          var label = '#tab_update_checkbox' + id;
          var text_id = 'tab_update_text' + id;
          if($(label).prop('checked') === true){
            res[text_id] = data.field[text_id];
          }
          else{
            res[text_id] = '';
          }
        }
        tab_update_server_status.do_server_operation('执行更新', res);
        return false;
      });
      //监听服务器更新【清除提交】按钮
      form.on('submit(tab_update_clearall)', function(data){

        return true;
      });
      //监听tab_update【筛选】按钮
      form.on('submit(tab_update_filter)', function (data) {
        console.log(data);
        console.log(server_group_data);
        if (tab_update_server_status !== undefined) {
          tab_update_server_status.stop_interval_check();
        }
        var group_name = data.field.tab_update_choosegroup;
        var start_id = server_group_data[group_name]['group_start_id'];
        var end_id = server_group_data[group_name]['group_end_id'];
        var send_data = {
          'start_id': start_id,
          'end_id': end_id
        };
        send_msg_to_server(1, send_data, function (res) {
          console.log(res);
          tab_update_server_status = new ServerStatusSuit('tab_update_status', res, group_name, 10000, layui);
          tab_update_server_status.generate_table();
          tab_update_server_status.start_interval_check();
        });
        return false;
      });
      //监听【查询服务器】按钮
      form.on('submit(tab_copy_filter)', function (data) {
        console.log(data);
        console.log(server_group_data);
        if (tab_copy_server_status !== undefined) {
          tab_copy_server_status.stop_interval_check();
        }
        var group_name = data.field.tab_copy_choose_group;
        var start_id = server_group_data[group_name]['group_start_id'];
        var end_id = server_group_data[group_name]['group_end_id'];
        var send_data = {
          'start_id': start_id,
          'end_id': end_id
        };
        send_msg_to_server(1, send_data, function (res) {
          console.log(res);
          tab_copy_server_status = new ServerStatusSuit('tab_copy_status', res, group_name, 10000, layui);
          tab_copy_server_status.generate_table();
          tab_copy_server_status.start_interval_check();
        });
        return false;
      });
      //监听服务器拷贝【执行】按钮
      form.on('submit(tab_copy_exec)', function (data) {
        tab_copy_server_status.do_server_operation(data.field.tab_copy_operation, data);
        return false;
      });
      //监听【筛选】按钮
      form.on('submit(filter)', function (data) {
        console.log(data);
        console.log(server_group_data);
        if (tab_oper_server_status !== undefined) {
          tab_oper_server_status.stop_interval_check();
        }
        var group_name = data.field.choose_server;
        var start_id = server_group_data[group_name]['group_start_id'];
        var end_id = server_group_data[group_name]['group_end_id'];
        var send_data = {
          'start_id': start_id,
          'end_id': end_id
        };
        send_msg_to_server(1, send_data, function (res) {
          console.log(res);
          tab_oper_server_status = new ServerStatusSuit('tab_oper_status', res, group_name, 5000, layui);
          tab_oper_server_status.generate_table();
          tab_oper_server_status.start_interval_check();
        });
        return false;
      });

      //监听tab_copy的select事件：选择拷贝源
      form.on('select(tab_copy_choose_source)', function (data) {
        console.log(data);
        var label = '#tab_copy_choose_version';
        $(label).empty();
        switch (data.value) {
          case "内网Branches":
            $(label).append("<option value=''>请选择版本</option>");
            send_data = {
              user: 'branches',
              ip: '192.168.1.5',
              port: 22,
              cmd: 'ls ~/sg_server/branches'
            }
            send_msg_to_server(8, send_data, function (res) {
              console.log(res);
              var array = res.split('\n');
              array.pop();
              console.log(array);
              for (idx in array) {
                var version = array[idx];
                $(label).append("<option value='" + version + "'>" + version + "</option>");
              }
              renderForm();
            });
            break;
          case "内网Trunk":
            $(label).append("<option value='最新版'>最新版</option>");
            renderForm();
            break;
        }
      });
    });

    //页面预加载
    $(document).ready(function () {
      var data = [{
        'table_name': 'server_group',
      }];
      //填充服务器组select栏数据
      get_need_info_and_callback_it('sg_gm', data, function (res) {
        console.log(res);
        for (idx in res) {
          $('#group').append("<option value='" + res[idx]['group_name'] + "'>" + res[idx]['group_name'] + "</option>");
          $('#tab_copy_choose_group').append("<option value='" + res[idx]['group_name'] + "'>" + res[idx]['group_name'] + "</option>");
          $('#tab_update_choosegroup').append("<option value='" + res[idx]['group_name'] + "'>" + res[idx]['group_name'] + "</option>");
          server_group_data[res[idx]['group_name']] = res[idx];
        }
        renderForm();
      });

      //填充tab_copy页的拷贝源数据
      $('#tab_copy_choose_source').append("<option value='内网Branches'>内网Branches</option>");
      $('#tab_copy_choose_source').append("<option value='内网Trunk'>内网Trunk</option>");

      //生成tab log
      tab_actionlog.initTab();
      tab_copylog.initTab();
      tab_updatelog.initTab();
    });
    </script>
  </body>

</html>