<!DOCTYPE HTML>
<html>

<head>
	<meta charset="utf-8">
	<meta name="renderer" content="webkit|ie-comp|ie-stand">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	<meta http-equiv="Cache-Control" content="no-siteapp" />
	<!--[if lt IE 9]>
<script type="text/javascript" src="lib/html5shiv.js"></script>
<script type="text/javascript" src="lib/respond.min.js"></script>
<![endif]-->
	<link rel="stylesheet" type="text/css" href="../dep/static/h-ui/css/H-ui.min.css" />
	<link rel="stylesheet" type="text/css" href="../dep/static/h-ui.admin/css/H-ui.admin.css" />
	<link rel="stylesheet" type="text/css" href="../dep/lib/Hui-iconfont/1.0.8/iconfont.css" />
	<link rel="stylesheet" type="text/css" href="../dep/static/h-ui.admin/skin/default/skin.css" id="skin" />
	<link rel="stylesheet" type="text/css" href="../dep/static/h-ui.admin/css/style.css" />
	<link rel="stylesheet" type="text/css" href="../dep/lib/layui/css/layui.css" />
	<script type="text/javascript" src="../dep/lib/jquery/1.9.1/jquery.min.js"></script>
	<script type="text/javascript" src="../dep/static/h-ui/js/H-ui.min.js"></script>
	<script type="text/javascript" src="../dep/static/h-ui.admin/js/H-ui.admin.js"></script>
	<script type="text/javascript" src="../dep/lib/My97DatePicker/4.8/WdatePicker.js"></script>
	<script type="text/javascript" src="../dep/lib/datatables/1.10.0/jquery.dataTables.min.js"></script>
	<script type="text/javascript" src="../dep/lib/layui/layui.js" charset="utf-8"></script>
	<script type="text/javascript" src="../dep/js/server_list_common.js" charset="utf-8"></script>
	<script type="text/javascript" src="../dep/js/common.js" charset="utf-8"></script>
	<script type="text/javascript" src="../dep/lib/hcharts/Highcharts/5.0.6/js/highcharts.js"></script>
	<script type="text/javascript" src="../dep/lib/hcharts/Highcharts/5.0.6/js/modules/exporting.js"></script>
	<script type="text/javascript" src="../dep/js/config.js" charset="utf-8"></script>
	<title>后台监控</title>
	<style type="text/css">
	</style>
</head>

<body>
	<div class="layui-tab layui-tab-card">
		<ul class="layui-tab-title">
			<li class="layui-this">渠道标签</li>
			<li>账号服配置</li>
			<li>登录服配置</li>
		</ul>
		<div class="layui-tab-content">
			<div class="layui-tab-item layui-show" id="tab_mark">
				<form class="layui-form" action="">
					<div class="layui-row">
						<div class="layui-col-lg1">
							<label class="layui-form-label">游戏</label>
						</div>
						<div class="layui-col-lg4">
							<select name="choose_game" lay-filter="tab_mark_choose_game" lay-verify="required">
								<option value="">请选择游戏</option>
								<option value="0">少年逆命师</option>
							</select>
						</div>

						<div class="layui-col-lg1">
							<label class="layui-form-label">标签过滤</label>
						</div>

						<div class="layui-col-lg4">

							<input type="text" name="title" required lay-verify="optional" placeholder="请输入标签关键字" autocomplete="off" class="layui-input">

						</div>

						<div class="layui-col-lg1 layui-col-md-offset1">
							<div class="layui-btn-group">
								<button class="layui-btn" lay-submit lay-filter='tab_mark_query'>查询</button>
								<button class="layui-btn" lay-submit lay-filter='tab_mark_new'>新增</button>
							</div>
						</div>
					</div>
					<div class="layui-row">
						<div class="layui-input-block"></div>
					</div>
				</form>
				<table id="tab_mark_table" lay-filter="tab_mark_table"></table>
			</div>

			<div class="layui-tab-item" id="tab_account">
				<form class="layui-form" action="">
					<div class="layui-row">
						<div class="layui-col-lg1">
							<label class="layui-form-label">游戏</label>
						</div>
						<div class="layui-col-lg4">
							<select name="choose_game" lay-filter="tab_account_choose_game" lay-verify="required">
								<option value="">请选择游戏</option>
								<option value="0">少年逆命师</option>
							</select>
						</div>

						<div class="layui-col-lg1">
							<label class="layui-form-label">服务器组</label>
						</div>

						<div class="layui-col-lg4">

							<select name="choose_group" lay-verify="required">
								<option value=""></option>
							</select>
						</div>

						<div class="layui-col-lg1 layui-col-md-offset1">
							<div class="layui-btn-group">
								<button class="layui-btn" lay-submit lay-filter='tab_account_query'>查询</button>
								<button class="layui-btn" lay-submit lay-filter='tab_account_new'>新增</button>
							</div>
						</div>
					</div>
					<div class="layui-row">
						<div class="layui-input-block"></div>
					</div>
				</form>
				<table id="tab_account_table" lay-filter="tab_account_table"></table>
			</div>

			<div class="layui-tab-item" id="tab_login">
				<form class="layui-form" action="">
					<div class="layui-row">
						<div class="layui-col-lg1">
							<label class="layui-form-label">游戏</label>
						</div>
						<div class="layui-col-lg4">
							<select name="choose_game" lay-filter="tab_login_choose_game" lay-verify="required">
								<option value="">请选择游戏</option>
								<option value="0">少年逆命师</option>
							</select>
						</div>

						<div class="layui-col-lg1">
							<label class="layui-form-label">服务器组</label>
						</div>

						<div class="layui-col-lg4">

							<select name="choose_group" lay-verify="required">
								<option value=""></option>
							</select>
						</div>

						<div class="layui-col-lg1 layui-col-md-offset1">
							<div class="layui-btn-group">
								<button class="layui-btn" lay-submit lay-filter='tab_login_query'>查询</button>
								<button class="layui-btn" lay-submit lay-filter='tab_login_new'>新增</button>
							</div>
						</div>
					</div>
					<div class="layui-row">
						<div class="layui-input-block"></div>
					</div>
				</form>
				<table id="tab_login_table" lay-filter="tab_login_table"></table>
			</div>
		</div>
	</div>
</body>
<script>
	function ThisInterface(id, layui, onSelectGame) {
		this.id = id;
		this.label = '#' + this.id;
		this.layui = layui;
		this.onSelectGame = onSelectGame;
	}

	ThisInterface.prototype.init = function () {
		this.listenSelectGame();
		this.listenQuery();
		this.listenNew();
	}

	ThisInterface.prototype.gen = function () {
		$(this.label).append('');
	}

	ThisInterface.prototype.getSelector = function (selector) {
		if (selector === undefined) {
			return '#' + this.id;
		}
		return '#' + this.id + ' ' + selector;
	}

	ThisInterface.prototype.getFilterName = function (name) {
		return this.id + '_' + name;
	}

	ThisInterface.prototype.listenSelectGame = function () {
		var self = this;
		this.layui.use(['form'], function () {
			var form = self.layui.form;
			var filter = 'select(' + self.getFilterName('choose_game') + ')';
			form.on(filter, self.onSelectGame);
			// form.on(filter, function (data) {
			// 	var selector = self.getSelector('[name="choose_group"]');
			// 	$(selector).empty();
			// 	$(selector).append("<option value='a'>a</option>");
			// 	renderForm();
			// });
		});
	}

	ThisInterface.prototype.listenQuery = function () {
		var self = this;
		this.layui.use(['form'], function () {
			var form = self.layui.form;
			var filter = 'submit(' + self.getFilterName('query') + ')';
			form.on(filter, function (data) {
				console.log(data);
				if (self.query_func !== undefined) {
					self.query_func(data);
				}
				return false;
			});
		});
	}

	ThisInterface.prototype.regQueryFunc = function (query_func) {
		this.query_func = query_func;
	}

	ThisInterface.prototype.listenNew = function () {
		var self = this;
		this.layui.use(['form'], function () {
			var form = self.layui.form;
			var filter = 'submit(' + self.getFilterName('new') + ')';
			form.on(filter, function (data) {
				console.log(data);
				// if (data.elem.className === "layui-btn layui-btn-disabled") {
				// 	return false;
				// }
				//添加新标签
				if (self.new_func !== undefined) {
					self.new_func(data);
				}
				return false;
			});
		});
	}

	ThisInterface.prototype.regNewFunc = function (new_func) {
		this.new_func = new_func;
	}

	function genLoginTable(obj){
		console.log(obj);
		var range_array = obj.field.choose_group.split(',');

		rpc_call('mark', 'query_login', { range: range_array }, function (res) {
			console.log(res);
			//res.data.forEach
			var table = layui.table;
			table.render({
				elem: '#tab_login_table',
				cols: [[
					{ checkbox: true },
					{ field: 'server_name', title: '登录服名称' },
					{ field: 'ip', title: 'ip' },
					{ field: 'port', title: 'port' },
					{ field: 'mark_type', title: '渠道类型标记' },
					{
						field: 'modify', title: '操作', align: 'center', width: 100, toolbar:
							"<script type=\"text/html\"><a class=\"layui-btn layui-btn-sm\" lay-event=\"edit\">修改<\/a><\/script>"
					}
				]],
				page: true,
				data: res.data,
				limit: 20,
				done: function () {
					table.on('tool(tab_login_table)', function (obj) {
						console.log(obj);
						var data = [
							{ type: "<em>server_name</em>", data: obj.data.server_name },
							{ type: "<em>ip</em>", data: obj.data.ip },
							{ type: "<em>port</em>", data: obj.data.port },
							{ type: "<em>mark_type</em>", data: obj.data.mark_type },
						];
						layerTable('table_login_modify', data, function (edit_line) {
							return function (res, cur, count) {
								setTableGridNotEdit('table_login_modify', [3], 'data');
							}
						});
					});
				}
			});
		});
	}

	function genAccountTable(obj) {
		console.log(obj);
		var range_array = obj.field.choose_group.split(',');

		rpc_call('mark', 'query_account', { range: range_array }, function (res) {
			console.log(res);
			//res.data.forEach
			var table = layui.table;
			table.render({
				elem: '#tab_account_table',
				cols: [[
					{ checkbox: true },
					{ field: 'server_name', title: '账号服名称' },
					{ field: 'ip', title: 'ip' },
					{ field: 'port', title: 'port' },
					{ field: 'mark_type', title: '渠道类型标记' },
					{
						field: 'modify', title: '操作', align: 'center', width: 100, toolbar:
							"<script type=\"text/html\"><a class=\"layui-btn layui-btn-sm\" lay-event=\"edit\">修改<\/a><\/script>"
					}
				]],
				page: true,
				data: res.data,
				limit: 20,
				done: function () {
					table.on('tool(tab_account_table)', function (obj) {
						console.log(obj);
						var data = [
							{ type: "<em>server_name</em>", data: obj.data.server_name },
							{ type: "<em>ip</em>", data: obj.data.ip },
							{ type: "<em>port</em>", data: obj.data.port },
							{ type: "<em>mark_type</em>", data: obj.data.mark_type },
						];
						layerTable('table_account_modify', data, function (edit_line) {
							return function (res, cur, count) {
								setTableGridNotEdit('table_account_modify', [3], 'data');
							}
						});
					});
				}
			});
		});
	}

	function genMarkTable(obj) {
		rpc_call('mark', 'query_mark', { filter: obj.field.title }, function (res) {
			console.log(res);
			var table = layui.table;
			table.render({
				elem: '#tab_mark_table' //指定原始表格元素选择器（推荐id选择器）
				, cols: [[ //标题栏
					{ checkbox: true }
					, { field: 'mark_type', title: '标签名称' }
					, { field: 'platform_name', title: '平台名称' }
					, { field: 'channel_name', title: '渠道名称' }
					, { field: 'compatible_version', title: '客户端兼容版本号' }
					, { field: 'version', title: '客户端最新版本号' }
					, {
						field: 'modify', title: '操作', align: 'center', width: 100, toolbar:
							"<script type=\"text/html\"><a class=\"layui-btn layui-btn-sm\" lay-event=\"edit\">修改<\/a><\/script>"
					}
				]]
				, data: res.data
				, page: true
				, limit: 20
				, done: function () {
					table.on('tool(tab_mark_table)', function (obj) {
						console.log(obj);
						send_msg = { mark_type: obj.data['mark_type'] };
						rpc_call('mark', 'query_all', send_msg, function (res) {
							console.log(res);
							var transfer_data = transferDataForLayerTable(res.data[0]);
							console.log(transfer_data);
							layerTable('table111', transfer_data, function (edit_line) {
								return function (res, cur, count) {
									console.log(res);
									setTableGridNotEdit('table111', [0, 10, 11], 'data');
									setTableGridClickFunc('table111', [11], 'data', onClickCol('account', edit_line));
									setTableGridClickFunc('table111', [10], 'data', onClickCol('login', edit_line));
								}
							});
							return false;
						});
					});
				}
			});
		});
	}

	// function layerTable(layui){
	// 	this.layui = layui;
	// 	this.edit_line = {};
	// }

	function layerTable(table_id, data, func_table_done, func_submit) {
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form;
		// var [ ...data ] = origin_data;
		// console.log(origin_data);
		// console.log(data);
		var edit_line = {};

		layer.open({
			type: 1,
			content:
				'<form class="layui-form" action="">\
			<table id="' + table_id + '" lay-filter="' + table_id + '"></table>\
			<div class="layui-row">\
				<div class="layui-col-lg1 layui-col-md-offset8">\
					<button class="layui-btn" lay-submit id="' + table_id + '_button" lay-filter="' + table_id + '_button">提交</button>\
				</div>\
			</div>\
			</form>',
			area: ['900px', '700px'],
			success: function (layero, index) {
				//console.log(layero);
				//console.log(index);
				console.log(data);
				console.log(mark_table_format_data);
				table.render({
					elem: '#' + table_id
					, cols: [[
						{ field: 'type', title: '类别', width: '20%' },
						{ field: 'data', title: '内容', width: '80%', edit: 'text' }
					]]
					, data: data
					, page: false
					, limit: 20
					, done: func_table_done(edit_line)
				});
				table.on('edit(' + table_id + ')', function (obj) {
					console.log(obj);
					var tmp = obj.data.type.slice(4);
					tmp = tmp.slice(0, -5);
					edit_line[tmp] = obj.value;
				});
				var button_selector = '#' + table_id + '_button';
				if(func_submit !== undefined){
					form.on('submit(' + table_id + '_button)', func_submit(edit_line, button_selector));
				}
				// form.on('submit(' + table_id + '_button)', function (sub_data) {
				// 	rpc_call('mark', 'update', edit_line, function (res) {
				// 		console.log(res);

				// 	})
				// 	return false;
				// });
			}
		});
	}

	function onClickCol(type, edit_line) {
		var table = layui.table;
		return function (event) {
			console.log(event);
			//event.target.childNodes[0].nodeValue = '!!!!';
			var func = '';
			var label = '';
			switch (type) {
				case 'account':
					func = 'query_account';
					label = 'account_server_name';
					break;
				case 'login':
					func = 'query_login';
					label = 'login_server_name';
					break;
				default:
					return;
			}
			rpc_call('mark', func, '', function (res) {
				console.log(res);
				if (event.target.childNodes.length == 0) {
					var node_text = document.createTextNode('');
					event.target.appendChild(node_text);
				}
				var names = event.target.childNodes[0].nodeValue;
				var array_name = names.split(';');
				array_name.forEach(ele => {
					res.data.forEach(element => {
						if (element.server_name == ele) {
							element['LAY_CHECKED'] = true;
						}
					});
				});
				layer.open({
					type: 1,
					content: '<table id="table1" lay-filter="table1"></table>',
					area: '800px',
					cancel: function (index, layero) {
						var checkStatus = table.checkStatus('table1');
						console.log(checkStatus);
						var show_data = '';
						checkStatus.data.forEach(ele => {
							show_data += ele.server_name;
							show_data += ';';
						});
						if (show_data != '') {
							show_data = show_data.slice(0, -1);
						}
						event.target.childNodes[0].nodeValue = show_data;
						edit_line[label] = show_data;
					},
					success: function (layero, index) {
						table.render({
							elem: '#table1',
							cols: [[
								{ checkbox: true },
								{ field: 'server_name', title: '服务器名称' },
								{ field: 'ip', title: '服务器IP' },
								{ field: 'port', title: '服务器PORT' }
							]],
							data: res.data,
							done: function (res, cur, count) {
								//勾选已有的名称
								// var array_name = names.split(';');
								// array_name.forEach(ele => {

								// });
								//setTabelGridChecked('table1', 0);
								// var checkStatus = table.checkStatus('table1');
								// console.log(checkStatus);
								// table.on('checkbox(table1)', function (obj) {
								// });
							},
						});
					}
				});
			});

		}
	}

	function setTabelGridChecked(table_id, index) {
		var dom = $('#' + table_id + ' + div tbody [data-index="' + index + '"] .layui-form-checkbox');
		dom.attr('class', 'layui-unselect layui-form-checkbox layui-form-checked');
	}

	function setTableGridNotEdit(table_id, index_array, col_name) {
		index_array.forEach(index => {
			var dom = $('#' + table_id + ' + div tbody [data-index="' + index + '"] [data-field="' + col_name + '"]');
			dom.attr('data-edit', false);
		});
	}

	function setTableGridClickFunc(table_id, index_array, col_name, func) {
		index_array.forEach(index => {
			var dom = $('#' + table_id + ' + div tbody [data-index="' + index + '"] [data-field="' + col_name + '"]');
			//var para = dom.children('div').text();
			//dom.bind('click', para, func);
			dom.click(func);
		});
	}

	function transferDataForLayerTable(data) {
		var res = [];
		for (idx in data) {
			res.push({ type: '<em>' + idx + '</em>', data: data[idx] });
		}
		return res;
	}

	function mark_table_format_data() {
		return new Array(
			{ type: "<em>mark_type</em>" },
			{ type: "<em>platform_name</em>" },
			{ type: "<em>channel_name</em>" },
			{ type: "<em>version</em>" },
			{ type: "<em>compatible_version</em>" },
			{ type: "<em>bbs_url</em>" },
			{ type: "<em>plist_url</em>" },
			{ type: "<em>notice_url</em>" },
			{ type: "<em>res_url</em>" },
			{ type: "<em>combat_url</em>" },
			{ type: "<em>login_server_name</em>" },
			{ type: "<em>account_server_name</em>" }, );
	}

	// var mark_table_format_data = [
	// 	{ type: "<em>mark_type</em>" },
	// 	{ type: "<em>platform_name</em>" },
	// 	{ type: "<em>channel_name</em>" },
	// 	{ type: "<em>version</em>" },
	// 	{ type: "<em>compatible_version</em>" },
	// 	{ type: "<em>bbs_url</em>" },
	// 	{ type: "<em>plist_url</em>" },
	// 	{ type: "<em>notice_url</em>" },
	// 	{ type: "<em>res_url</em>" },
	// 	{ type: "<em>combat_url</em>" },
	// 	{ type: "<em>login_server_name</em>" },
	// 	{ type: "<em>account_server_name</em>" },
	// ];

	function getEmData(data) {
		return '<em>' + data + '</em>';
	}

	var interface_mark = new ThisInterface('tab_mark', layui);
	interface_mark.init();
	interface_mark.regQueryFunc(genMarkTable);
	interface_mark.regNewFunc(function (obj) {
		console.log(obj);
		layerTable('table', mark_table_format_data(), function (edit_line) {
			return function (res, cur, count) {
				//console.log(res);
				setTableGridNotEdit('table', [10, 11], 'data');
				setTableGridClickFunc('table', [11], 'data', onClickCol('account', edit_line));
				setTableGridClickFunc('table', [10], 'data', onClickCol('login', edit_line));
			}
		}, function (changed_data, button_selector) {
			return function () {
				if ($(button_selector).attr('class') === "layui-btn layui-btn-disabled") {
					return false;
				}

				if (changed_data['mark_type'] === '' || changed_data['mark_type'] === undefined) {
					alert('mark_type是必填项');
					return false;
				}
				console.log(changed_data);
				rpc_call('mark', 'insert', changed_data, function (res) {
					if (res.code === 200) {
						$(button_selector).attr('class', "layui-btn layui-btn-disabled");
						$(button_selector).text('已提交');
					}
					else {
						alert('参数错误');
					}
				});
				return false;
			}
		});
		return false;
	});

	function account_table_format_data() {
		return new Array(
			{ type: "<em>global_id</em>" },
			{ type: "<em>server_name</em>" },
			{ type: "<em>ip</em>" },
			{ type: "<em>port</em>" },
			{ type: "<em>mark_type</em>", style: 'background-color: #eee;' },
		);
	}

	// var account_table_format_data = [
	// 	{ type: "<em>server_name</em>" },
	// 	{ type: "<em>ip</em>" },
	// 	{ type: "<em>port</em>" },
	// 	{ type: "<em>mark_type</em>", style: 'background-color: #eee;' },
	// ];
	var interface_account = new ThisInterface('tab_account', layui, function (data) {
		console.log(1111);
		console.log(data);
		//TODO self not defined
		var selector = '#tab_account [name="choose_group"]';
		$(selector).empty();
		rpc_call('serveroper', 'query_group', { game: data.vallue }, function (res) {
			console.log(res);
			res.data.forEach(ele => {
				$(selector).append("<option value='" + ele.global_start_id + ',' + ele.global_end_id + "'>" + ele.group_name + "</option>");
			});
			renderForm();
		});
	});
	interface_account.init();
	interface_account.regQueryFunc(genAccountTable);
	interface_account.regNewFunc(function (obj) {
		console.log(obj);
		layerTable('table_new_account', account_table_format_data(), function (edit_line) {
			return function (res, cur, count) {
				setTableGridNotEdit('table_new_account', [4], 'data');
			}
		}, function (changed_data, button_selector) {
			return function () {
				if ($(button_selector).attr('class') === "layui-btn layui-btn-disabled") {
					return false;
				}

				// if (changed_data['server_name'] === '' || changed_data['server_name'] === undefined) {
				// 	alert('mark_type是必填项');
				// 	return false;
				// }
				console.log(changed_data);
				rpc_call('mark', 'add_account', changed_data, function (res) {
					if (res.code === 200) {
						$(button_selector).attr('class', "layui-btn layui-btn-disabled");
						$(button_selector).text('已提交');
					}
					else {
						alert('参数错误');
					}
				});
				return false;
			}
		});
	});

	function login_table_format_data() {
		return new Array(
			{ type: "<em>server_id</em>" },
			{ type: "<em>server_name</em>" },
			{ type: "<em>ip</em>" },
			{ type: "<em>port</em>" },
			{ type: "<em>mark_type</em>", style: 'background-color: #eee;' },
		);
	}

	var interface_login = new ThisInterface('tab_login', layui, function (data) {
		console.log(data);
		//TODO self not defined
		var selector = '#tab_login [name="choose_group"]';
		$(selector).empty();
		rpc_call('serveroper', 'query_group', { game: data.vallue }, function (res) {
			console.log(res);
			res.data.forEach(ele => {
				$(selector).append("<option value='" + ele.group_start_id + ',' + ele.group_end_id + "'>" + ele.group_name + "</option>");
			});
			renderForm();
		});
	});
	interface_login.init();
	interface_login.regQueryFunc(genLoginTable);
	interface_login.regNewFunc(function (obj) {
		console.log(obj);
		layerTable('table_new_login', login_table_format_data(), function (edit_line) {
			return function (res, cur, count) {
				setTableGridNotEdit('table_new_login', [4], 'data');
			}
		}, function (changed_data, button_selector) {
			return function () {
				if ($(button_selector).attr('class') === "layui-btn layui-btn-disabled") {
					return false;
				}

				// if (changed_data['server_name'] === '' || changed_data['server_name'] === undefined) {
				// 	alert('mark_type是必填项');
				// 	return false;
				// }
				console.log(changed_data);
				rpc_call('mark', 'add_login', changed_data, function (res) {
					if (res.code === 200) {
						$(button_selector).attr('class', "layui-btn layui-btn-disabled");
						$(button_selector).text('已提交');
					}
					else {
						alert('参数错误');
					}
				});
				return false;
			}
		});
	});

	layui.use(['form', 'layedit', 'element', 'table', 'laydate', 'layer'], function () {
		var form = layui.form;
		var table = layui.table;
	});
</script>

</html>